#!/usr/bin/php
<?php
/**
 * Copyright 2016 FranÃ§ois Kooman <fkooman@tuxed.net>.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
require_once dirname(__DIR__).'/vendor/autoload.php';

use fkooman\Config\YamlFile;

function showHelp(array $argv)
{
    return implode(
        PHP_EOL,
        [
            sprintf('SYNTAX: %s [--instance domain.tld:443] --user username --pass password', $argv[0]),
            '',
            '--instance domain.tld:443  the instance to add the user to, defaults to',
            '                           "one-instance" configuration if not specified',
            '--user username            the user name',
            '--pass password            the plain text password',
            '',
        ]
    );
}

try {
    $instanceId = null;
    $userName = null;
    $userPass = null;

    for ($i = 1; $i < $argc; ++$i) {
        if ('--instance' === $argv[$i] || '-i' === $argv[$i]) {
            if (array_key_exists($i + 1, $argv)) {
                $instanceId = $argv[$i + 1];
                ++$i;
            }
        }
        if ('--user' === $argv[$i] || '-u' === $argv[$i]) {
            if (array_key_exists($i + 1, $argv)) {
                $userName = $argv[$i + 1];
                ++$i;
            }
        }
        if ('--pass' === $argv[$i] || '-p' === $argv[$i]) {
            if (array_key_exists($i + 1, $argv)) {
                $userPass = $argv[$i + 1];
                ++$i;
            }
        }
    }

    if (is_null($userName) || is_null($userPass)) {
        echo showHelp($argv);
        exit(1);
    }

    $passwordHash = password_hash($userPass, PASSWORD_DEFAULT);

    $configFile = sprintf('%s/config/config.yaml', dirname(__DIR__));
    if (!is_null($instanceId)) {
        $configFile = sprintf('%s/config/%s/config.yaml', dirname(__DIR__), $instanceId);
    }

    $yamlFile = new YamlFile($configFile);
    $configData = $yamlFile->readConfig();
    $configData['FormAuthentication'][$userName] = $passwordHash;

    $yamlFile->writeConfig($configData);
} catch (Exception $e) {
    echo $e->getMessage().PHP_EOL;
    exit(1);
}
