#!/usr/bin/php
<?php

require_once 'vendor/autoload.php';

use fkooman\OpenVPN\Manage;
use fkooman\Ini\IniReader;
use fkooman\OpenVPN\VpnCertServiceClient;
use GuzzleHttp\Client;

try {
    $iniReader = IniReader::fromFile(
        dirname(__DIR__).'/config/manage.ini'
    );

    if (1 >= $argc) {
        throw new Exception('specify ID to kill, use status command to obtain');
    }

    // VPN Certificate Service Configuration
    $serviceUri = $iniReader->v('VpnCertService', 'serviceUri');
    $serviceAuth = $iniReader->v('VpnCertService', 'serviceUser');
    $servicePass = $iniReader->v('VpnCertService', 'servicePass');
    $client = new Client(
        array(
            'defaults' => array(
                'auth' => array($serviceAuth, $servicePass),
            ),
        )
    );
    $vpnCertServiceClient = new VpnCertServiceClient($client, $serviceUri);
    $vpnCertServiceClient->revokeConfiguration($argv[1]);

    $manage = new Manage($iniReader->v('socket'));
    echo $manage->killClient($argv[1]);
} catch (Exception $e) {
    echo $e->getMessage().PHP_EOL;
    exit(1);
}
